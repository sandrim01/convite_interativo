{% extends "base.html" %}

{% block title %}Painel Administrativo - Alessandro & [Nome da Noiva]{% endblock %}

{% block head %}
<style>
/* Estilos espec√≠ficos para o painel admin */
:root {
    --admin-primary: #8B1538;
    --admin-secondary: #C85A6E;
    --admin-accent: #2C3E50;
    --admin-success: #28a745;
    --admin-danger: #dc3545;
    --admin-warning: #ffc107;
    --admin-light: #f8f9fa;
    --admin-dark: #343a40;
}

.admin-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 0;
}

.admin-header {
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(139, 21, 56, 0.3);
}

.admin-header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-title h1 {
    font-family: 'Dancing Script', cursive;
    font-size: 2.5rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.admin-title p {
    font-style: italic;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
}

.admin-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.admin-status {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.9rem;
}

.btn-logout {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
    padding: 0.7rem 1.5rem;
    border-radius: 25px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-logout:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.admin-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
}

.section-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    border-top: 4px solid var(--admin-primary);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f8f9fa;
}

.section-header h3 {
    font-family: 'Playfair Display', serif;
    color: var(--admin-primary);
    font-size: 1.8rem;
    margin: 0;
}

.section-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(139, 21, 56, 0.3);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.admin-table th {
    background: var(--admin-primary);
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.admin-table td {
    padding: 1rem;
    border-bottom: 1px solid #f8f9fa;
    vertical-align: top;
}

.admin-table tbody tr:hover {
    background: rgba(139, 21, 56, 0.05);
}

.admin-table tbody tr:nth-child(even) {
    background: #f8f9fa;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.link-btn {
    color: var(--admin-primary);
    text-decoration: none;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    background: rgba(139, 21, 56, 0.1);
    transition: all 0.3s ease;
}

.link-btn:hover {
    background: var(--admin-primary);
    color: white;
}

@media (max-width: 768px) {
    .admin-header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .admin-title h1 {
        font-size: 2rem;
    }
    
    .admin-content {
        padding: 0 1rem;
    }
    
    .admin-table {
        font-size: 0.8rem;
    }
    
    .admin-table th,
    .admin-table td {
        padding: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div class="admin-header-content">
            <div class="admin-title">
                <h1><i class="fas fa-heart"></i> Painel dos Noivos</h1>
                <p>Alessandro & [Nome da Noiva] - Gerenciamento do Casamento</p>
            </div>
            <div class="admin-actions">
                <span class="admin-status">
                    <i class="fas fa-user-crown"></i>
                    Logado como Administrador
                </span>
                <a href="{{ url_for('admin_logout') }}" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </a>
            </div>
        </div>
    </div>

    <div class="admin-content">
        <!-- Estat√≠sticas Resumidas -->
        <div class="stats-row">
            <div class="stat-card">
                <span class="stat-number">{{ convidados|length }}</span>
                <span class="stat-label">Convidados Confirmados</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ presentes|selectattr('reservado_por')|list|length }}</span>
                <span class="stat-label">Presentes Reservados</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ presentes|length - presentes|selectattr('reservado_por')|list|length }}</span>
                <span class="stat-label">Presentes Dispon√≠veis</span>
            </div>
        </div>

        <!-- Se√ß√£o Convidados -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>Convidados Confirmados</h3>
            </div>
            
            {% if convidados %}
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Nome</th>
                            <th><i class="fas fa-envelope"></i> Email</th>
                            <th><i class="fas fa-phone"></i> Telefone</th>
                            <th><i class="fas fa-comment"></i> Mensagem</th>
                            <th><i class="fas fa-calendar"></i> Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in convidados %}
                        <tr>
                            <td><strong>{{ c.nome }}</strong></td>
                            <td>{{ c.email or '-' }}</td>
                            <td>{{ c.telefone or '-' }}</td>
                            <td>{{ c.mensagem or '-' }}</td>
                            <td>{{ c.criado_em.strftime('%d/%m/%Y %H:%M') if c.criado_em else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-users-slash"></i>
                <h4>Nenhum convidado confirmado ainda</h4>
                <p>Quando os convidados confirmarem presen√ßa, eles aparecer√£o aqui.</p>
            </div>
            {% endif %}
        </div>

        <!-- Se√ß√£o Presentes -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-gift"></i>
                </div>
                <h3>Lista de Presentes</h3>
            </div>
            
            {% if presentes %}
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-gift"></i> Nome do Presente</th>
                            <th><i class="fas fa-user-heart"></i> Reservado por</th>
                            <th><i class="fas fa-calendar-check"></i> Data da Reserva</th>
                            <th><i class="fas fa-external-link-alt"></i> Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in presentes %}
                        <tr>
                            <td><strong>{{ p.nome }}</strong></td>
                            <td>
                                {% if p.reservado_por %}
                                    <span style="color: var(--admin-success); font-weight: bold;">
                                        <i class="fas fa-heart"></i> {{ p.reservado_por }}
                                    </span>
                                {% else %}
                                    <span style="color: #6c757d;">
                                        <i class="fas fa-clock"></i> Dispon√≠vel
                                    </span>
                                {% endif %}
                            </td>
                            <td>{{ p.reservado_em.strftime('%d/%m/%Y %H:%M') if p.reservado_em else '-' }}</td>
                            <td>
                                <a href="{{ p.link }}" target="_blank" class="link-btn">
                                    <i class="fas fa-external-link-alt"></i> Ver na Amazon
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-gift"></i>
                <h4>Nenhum presente cadastrado</h4>
                <p>Adicione presentes √† sua lista de casamento.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i>
                                Carregando convidados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Se√ß√£o de Envio em Massa por WhatsApp -->
        <div class="whatsapp-section">
            <h3>Envio em Massa por WhatsApp</h3>
            <div class="whatsapp-controls">
                <div class="whatsapp-info">
                    <p><i class="fas fa-info-circle"></i> 
                       Gere links personalizados para envio em massa dos convites por WhatsApp apenas para convidados pendentes.
                    </p>
                </div>
                
                <div class="whatsapp-actions">
                    <button class="btn-whatsapp" onclick="gerarLinksWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                        Gerar Links WhatsApp (Pendentes)
                    </button>
                    
                    <button class="btn-whatsapp-all" onclick="enviarParaTodos()" style="display: none;">
                        <i class="fab fa-whatsapp"></i>
                        Enviar Para TODOS
                    </button>
                    
                    <button class="btn-whatsapp-all" onclick="envioMassaAlternativo()" style="display: none; margin-left: 10px; background: linear-gradient(135deg, #28a745, #20c997);">
                        <i class="fas fa-rocket"></i>
                        ENVIO DIRETO (Alternativo)
                    </button>
                    
                    <button class="btn-whatsapp-all" onclick="marcarTodosEnviados()" style="display: none; margin-left: 10px;">
                        <i class="fas fa-check-double"></i>
                        Marcar Todos como Enviados
                    </button>
                    
                    <!-- BOT√ÉO DE EMERG√äNCIA - SEMPRE VIS√çVEL -->
                    <button class="btn-emergencia" onclick="envioDeEmergencia()" style="margin-left: 10px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);">
                        <i class="fas fa-exclamation-triangle"></i>
                        üö® ENVIO EMERG√äNCIA üö®
                    </button>
                </div>
            </div>

            <!-- √Årea de resultado dos links -->
            <div id="links-whatsapp-container" style="display: none;">
                <h4>Links Gerados para WhatsApp:</h4>
                <div id="links-whatsapp-lista" class="links-lista">
                    <!-- Links ser√£o inseridos aqui via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Adicionar Presente -->
    <div id="tab-adicionar" class="tab-content">
        <h2>Adicionar Novo Presente</h2>
        <form id="form-adicionar-presente" class="form-admin">
            <div class="form-group">
                <label for="nome-presente">Nome do Presente:</label>
                <input type="text" id="nome-presente" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="descricao-presente">Descri√ß√£o:</label>
                <textarea id="descricao-presente" name="descricao" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="preco-presente">Pre√ßo (R$):</label>
                <input type="number" id="preco-presente" name="preco" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="categoria-presente">Categoria:</label>
                <select id="categoria-presente" name="categoria" required>
                    <option value="">Selecione uma categoria</option>
                    <option value="Cozinha">Cozinha</option>
                    <option value="Mesa e Bar">Mesa e Bar</option>
                    <option value="Eletrodom√©sticos">Eletrodom√©sticos</option>
                    <option value="Casa">Casa</option>
                    <option value="Decora√ß√£o">Decora√ß√£o</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="link-presente">Link da Amazon:</label>
                <input type="url" id="link-presente" name="link_amazon" required 
                       placeholder="https://amazon.com.br/dp/...">
            </div>
            
            <button type="submit" class="btn-adicionar">
                <i class="fas fa-plus"></i>
                Adicionar Presente
            </button>
        </form>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div id="modal-confirmacao" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="fecharModalConfirmacao()">&times;</span>
        <div class="modal-body">
            <i class="fas fa-check-circle modal-icon"></i>
            <h3>Sucesso!</h3>
            <p id="mensagem-modal">Opera√ß√£o realizada com sucesso!</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function mostrarTab(tabName) {
    // Esconder todas as abas
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover classe active de todos os bot√µes
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar aba selecionada
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Adicionar classe active ao bot√£o clicado
    event.target.classList.add('active');
}

// Adicionar presente
document.getElementById('form-adicionar-presente').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        nome: formData.get('nome'),
        descricao: formData.get('descricao'),
        preco: parseFloat(formData.get('preco')) || null,
        categoria: formData.get('categoria'),
        link_amazon: formData.get('link_amazon')
    };
    
    try {
        const response = await fetch('/api/adicionar-presente', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('mensagem-modal').textContent = 'Presente adicionado com sucesso!';
            document.getElementById('modal-confirmacao').style.display = 'block';
            this.reset();
            
            // Recarregar p√°gina ap√≥s 2 segundos
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Erro ao adicionar presente: ' + result.message);
        }
    } catch (error) {
        alert('Erro ao adicionar presente. Tente novamente.');
    }
});

// Remover presente
async function removerPresente(presenteId) {
    if (confirm('Tem certeza que deseja remover este presente da lista?')) {
        try {
            const response = await fetch(`/api/remover-presente/${presenteId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('mensagem-modal').textContent = 'Presente removido da lista!';
                document.getElementById('modal-confirmacao').style.display = 'block';
                
                // Recarregar p√°gina ap√≥s 2 segundos
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                alert('Erro ao remover presente: ' + result.message);
            }
        } catch (error) {
            alert('Erro ao remover presente. Tente novamente.');
        }
    }
}

function fecharModalConfirmacao() {
    document.getElementById('modal-confirmacao').style.display = 'none';
}

// Fechar modal clicando fora dele
window.onclick = function(event) {
    const modal = document.getElementById('modal-confirmacao');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

// ===== GERENCIAMENTO DE CONVIDADOS =====

// Carregar lista de convidados quando a aba for selecionada
function carregarConvidados() {
    fetch('/api/listar-convidados')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#tabela-convidados tbody');
            
            if (data.success && data.convidados.length > 0) {
                tbody.innerHTML = data.convidados.map(convidado => `
                    <tr>
                        <td><strong>${convidado.nome}</strong></td>
                        <td>${convidado.whatsapp || 'N/A'}</td>
                        <td>${convidado.email || 'N/A'}</td>
                        <td>
                            <span class="status status-${convidado.status_resposta}">
                                ${getStatusText(convidado.status_resposta)}
                            </span>
                        </td>
                        <td>
                            <span class="envio-status ${convidado.convite_enviado ? 'enviado' : 'nao-enviado'}">
                                ${convidado.convite_enviado ? 
                                    `<i class="fas fa-check"></i> ${convidado.data_envio_convite}` : 
                                    '<i class="fas fa-times"></i> N√£o enviado'
                                }
                            </span>
                        </td>
                        <td>${convidado.data_ultima_visita}</td>
                        <td>
                            <button class="btn-acao btn-copiar" onclick="copiarLink('${convidado.link_convite}')">
                                <i class="fas fa-copy"></i> Copiar Link
                            </button>
                        </td>
                        <td>
                            <div class="acoes-convidado">
                                ${convidado.whatsapp ? 
                                    `<button class="btn-acao btn-whatsapp-individual" onclick="enviarWhatsAppIndividual(${convidado.id})">
                                        <i class="fab fa-whatsapp"></i>
                                        Enviar WhatsApp
                                    </button>` : ''
                                }
                                ${!convidado.convite_enviado && convidado.whatsapp ? 
                                    `<button class="btn-acao btn-marcar-enviado" onclick="marcarConviteEnviado(${convidado.id})">
                                        <i class="fas fa-check"></i>
                                        Marcar Enviado
                                    </button>` : ''
                                }
                                <a href="${convidado.link_convite}" target="_blank" class="btn-acao btn-ver">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn-acao btn-excluir" onclick="excluirConvidado(${convidado.id}, '${convidado.nome}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-row">
                            <i class="fas fa-users"></i><br>
                            Nenhum convidado cadastrado ainda
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar convidados:', error);
            document.querySelector('#tabela-convidados tbody').innerHTML = `
                <tr>
                    <td colspan="8" class="error-row">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Erro ao carregar convidados
                    </td>
                </tr>
            `;
        });
}

function getStatusText(status) {
    const statusMap = {
        'pendente': 'Pendente',
        'convite_enviado': 'Convite Enviado',
        'confirmado': 'Confirmado',
        'nao_comparecera': 'N√£o Comparecer√°'
    };
    return statusMap[status] || status;
}

// Cadastrar novo convidado
document.getElementById('form-cadastrar-convidado').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        nome: formData.get('nome'),
        whatsapp: formData.get('whatsapp'),
        email: formData.get('email')
    };
    
    try {
        const response = await fetch('/api/cadastrar-convidado', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Convidado cadastrado com sucesso!\\nC√≥digo: ${result.codigo}\\nLink: ${result.link}`);
            this.reset();
            carregarConvidados(); // Recarregar lista
        } else {
            alert('Erro ao cadastrar convidado: ' + result.message);
        }
    } catch (error) {
        alert('Erro ao cadastrar convidado. Tente novamente.');
    }
});

// Copiar link do convite
function copiarLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copiado para a √°rea de transfer√™ncia!');
    }).catch(err => {
        console.error('Erro ao copiar link:', err);
        // Fallback para navegadores mais antigos
        const textarea = document.createElement('textarea');
        textarea.value = link;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Link copiado para a √°rea de transfer√™ncia!');
    });
}

// ===== FUN√á√ïES DO WHATSAPP =====

// Gerar links do WhatsApp para envio em massa
async function gerarLinksWhatsApp() {
    try {
        const response = await fetch('/api/gerar-links-whatsapp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            const container = document.getElementById('links-whatsapp-container');
            const lista = document.getElementById('links-whatsapp-lista');
            
            if (result.links.length > 0) {
                lista.innerHTML = result.links.map(link => `
                    <div class="link-whatsapp-item">
                        <div class="link-info">
                            <strong>${link.nome}</strong>
                            <span class="whatsapp-number">${link.whatsapp}</span>
                        </div>
                        <div class="link-actions">
                            <a href="${link.link_whatsapp}" target="_blank" class="btn-whatsapp-abrir">
                                <i class="fab fa-whatsapp"></i>
                                Abrir WhatsApp
                            </a>
                            <button class="btn-marcar-enviado" onclick="marcarConviteEnviado(${link.id})">
                                <i class="fas fa-check"></i>
                                Marcar como Enviado
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.style.display = 'block';
                
                // Armazenar IDs dos convidados para envio autom√°tico
                window.convidadosPendentes = result.links.map(link => link.id);
                
                // Mostrar bot√µes de a√ß√£o
                const botoesWhatsApp = document.querySelectorAll('.btn-whatsapp-all');
                if (botoesWhatsApp.length > 0) {
                    botoesWhatsApp[0].style.display = 'inline-block'; // Bot√£o "Enviar Para TODOS"
                    if (botoesWhatsApp.length > 1) {
                        botoesWhatsApp[1].style.display = 'inline-block'; // Bot√£o "ENVIO DIRETO (Alternativo)"
                    }
                    if (botoesWhatsApp.length > 2) {
                        botoesWhatsApp[2].style.display = 'inline-block'; // Bot√£o "Marcar Todos"
                    }
                }
                
                alert(`${result.total} links gerados com sucesso! Use "Enviar Para TODOS" para abrir todas as conversas simultaneamente.`);
            } else {
                alert('Nenhum link gerado. Verifique se h√° convidados com WhatsApp que ainda n√£o receberam convites.');
            }
        } else {
            alert('Erro ao gerar links: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao gerar links:', error);
        alert('Erro ao gerar links. Tente novamente.');
    }
}

// Marcar convite como enviado
async function marcarConviteEnviado(convidadoId) {
    try {
        const response = await fetch('/api/marcar-convite-enviado', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                convidado_id: convidadoId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            carregarConvidados(); // Recarregar lista
            
            // Remover o item da lista de links se existir
            const linkItem = document.querySelector(`button[onclick="marcarConviteEnviado(${convidadoId})"]`).closest('.link-whatsapp-item');
            if (linkItem) {
                linkItem.remove();
            }
        } else {
            alert('Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao marcar convite:', error);
        alert('Erro ao marcar convite. Tente novamente.');
    }
}

// Enviar Para TODOS os convidados pendentes - VERS√ÉO SIMPLIFICADA E ROBUSTA
async function enviarParaTodos() {
    console.log('=== INICIANDO ENVIO PARA TODOS ===');
    
    if (!window.convidadosPendentes || window.convidadosPendentes.length === 0) {
        alert('Nenhum convidado pendente encontrado. Gere os links primeiro.');
        return;
    }
    
    console.log('Convidados pendentes:', window.convidadosPendentes);
    
    if (!confirm(`Tem certeza que deseja enviar convites para ${window.convidadosPendentes.length} convidados SIMULTANEAMENTE? Isso abrir√° todas as conversas do WhatsApp de uma vez e marcar√° automaticamente como enviados.`)) {
        return;
    }
    
    try {
        // M√©todo 1: Buscar os links diretamente da API
        console.log('Buscando links da API...');
        
        const response = await fetch('/api/gerar-links-whatsapp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert('Erro ao buscar links: ' + result.message);
            return;
        }
        
        console.log('Links da API:', result.links);
        
        if (!result.links || result.links.length === 0) {
            alert('Nenhum link encontrado na API.');
            return;
        }
        
        // Abrir todos os links com m√©todo direto
        let contadorAbertos = 0;
        const totalLinks = result.links.length;
        
        console.log(`Abrindo ${totalLinks} links...`);
        
        for (let i = 0; i < result.links.length; i++) {
            const link = result.links[i];
            console.log(`Abrindo link ${i + 1}/${totalLinks} para ${link.nome}: ${link.link_whatsapp}`);
            
            try {
                // Abrir link com pequeno delay
                setTimeout(() => {
                    window.open(link.link_whatsapp, '_blank');
                    contadorAbertos++;
                    
                    console.log(`Link aberto ${contadorAbertos}/${totalLinks}`);
                    
                    // Se todos foram abertos, marcar como enviados
                    if (contadorAbertos === totalLinks) {
                        console.log('Todos os links foram abertos! Marcando como enviados...');
                        setTimeout(() => {
                            marcarTodosComoEnviadosAutomatico(window.convidadosPendentes);
                        }, 3000); // Aguarda 3 segundos
                    }
                }, i * 800); // Intervalo de 800ms entre cada abertura
                
            } catch (error) {
                console.error(`Erro ao abrir link ${i + 1}:`, error);
            }
        }
        
        alert(`Iniciando abertura de ${totalLinks} conversas do WhatsApp... Aguarde a marca√ß√£o autom√°tica.`);
        
    } catch (error) {
        console.error('Erro geral ao enviar para todos:', error);
        alert('Erro ao enviar convites. Verifique o console e tente novamente.');
    }
}

// Fun√ß√£o para marcar todos como enviados automaticamente - VERS√ÉO MELHORADA
async function marcarTodosComoEnviadosAutomatico(idsConvidados) {
    console.log('=== INICIANDO MARCA√á√ÉO AUTOM√ÅTICA ===');
    console.log('IDs para marcar:', idsConvidados);
    
    try {
        if (!idsConvidados || idsConvidados.length === 0) {
            console.log('Nenhum ID de convidado fornecido');
            return;
        }
        
        const response = await fetch('/api/enviar-whatsapp-automatico', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ids_convidados: idsConvidados
            })
        });
        
        const result = await response.json();
        console.log('Resposta da API:', result);
        
        if (result.success) {
            alert(`‚úÖ SUCESSO! ${result.total_atualizados} convites foram marcados como enviados automaticamente!`);
            carregarConvidados(); // Recarregar lista
            
            // Ocultar se√ß√£o de links
            document.getElementById('links-whatsapp-container').style.display = 'none';
            const botoesWhatsApp = document.querySelectorAll('.btn-whatsapp-all');
            botoesWhatsApp.forEach(btn => btn.style.display = 'none');
            
            console.log('Marca√ß√£o autom√°tica conclu√≠da com sucesso!');
        } else {
            console.error('Erro na API:', result.message);
            alert('Erro ao marcar convites automaticamente: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao marcar todos como enviados:', error);
        alert('Erro ao marcar convites automaticamente. Use o bot√£o "Marcar Todos como Enviados" manualmente.');
    }
}

// ENVIO MASSA ALTERNATIVO - M√âTODO DIRETO E SIMPLES
async function envioMassaAlternativo() {
    console.log('=== ENVIO MASSA ALTERNATIVO INICIADO ===');
    
    if (!confirm('M√âTODO ALTERNATIVO: Deseja enviar convites diretamente da API para todos os convidados pendentes? Isso abrir√° todas as conversas e marcar√° automaticamente como enviados.')) {
        return;
    }
    
    try {
        // Buscar convidados pendentes diretamente da API
        console.log('Buscando convidados pendentes...');
        
        const responseConvidados = await fetch('/api/listar-convidados', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultConvidados = await responseConvidados.json();
        
        if (!resultConvidados.success) {
            alert('Erro ao buscar convidados: ' + resultConvidados.message);
            return;
        }
        
        // Filtrar apenas os pendentes
        const pendentes = resultConvidados.convidados.filter(c => c.status_resposta === 'pendente' && c.whatsapp);
        
        if (pendentes.length === 0) {
            alert('Nenhum convidado pendente com WhatsApp encontrado.');
            return;
        }
        
        console.log(`Encontrados ${pendentes.length} convidados pendentes:`, pendentes);
        
        // Buscar links da API
        const responseLinks = await fetch('/api/gerar-links-whatsapp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultLinks = await responseLinks.json();
        
        if (!resultLinks.success) {
            alert('Erro ao gerar links: ' + resultLinks.message);
            return;
        }
        
        console.log(`Links gerados:`, resultLinks.links);
        
        // Abrir todos os links
        const links = resultLinks.links;
        let contador = 0;
        
        alert(`Abrindo ${links.length} conversas do WhatsApp...`);
        
        links.forEach((link, index) => {
            setTimeout(() => {
                console.log(`Abrindo ${index + 1}/${links.length}: ${link.nome}`);
                window.open(link.link_whatsapp, '_blank');
                contador++;
                
                // Quando todos abriram, marcar como enviados
                if (contador === links.length) {
                    setTimeout(() => {
                        console.log('Todos abertos, marcando como enviados...');
                        marcarAutomaticamentePorIds(links.map(l => l.id));
                    }, 2000);
                }
            }, index * 1000); // 1 segundo entre cada abertura
        });
        
    } catch (error) {
        console.error('Erro no envio alternativo:', error);
        alert('Erro no envio alternativo: ' + error.message);
    }
}

// FUN√á√ÉO DE EMERG√äNCIA - ENVIO DIRETO SEM DEPEND√äNCIAS
async function envioDeEmergencia() {
    console.log('üö® === MODO EMERG√äNCIA ATIVADO === üö®');
    
    if (!confirm('üö® MODO EMERG√äNCIA üö®\n\nEste m√©todo ir√°:\n1. Buscar TODOS os convidados pendentes\n2. Gerar links automaticamente\n3. Abrir WhatsApp para cada um\n4. Marcar como enviado\n\nTudo isso SEM precisar de login ou interface!\n\nContinuar?')) {
        return;
    }
    
    try {
        // Links diretos hardcoded para os 3 convidados conhecidos
        const convidadosEmergencia = [
            {
                id: 12,
                nome: 'ALESSANDRO DE ANDRADE JUNIOR',
                whatsapp: '28999330320',
                link: 'https://wa.me/5528999330320?text=Ol√°%20ALESSANDRO%20DE%20ANDRADE%20JUNIOR!%20%F0%9F%8E%89%0A%0ATemos%20uma%20surpresa%20especial%20para%20voc√™!%20%F0%9F%92%8C%0A%0AClique%20no%20link%20abaixo%20para%20receber%20seu%20convite%20de%20casamento%20interativo:%0A%0Ahttp://localhost:5000/convite/12%0A%0AN√£o%20perca%20esta%20celebra√ß√£o%20√∫nica!%20%F0%9F%92%95'
            },
            {
                id: 13,
                nome: 'IARA',
                whatsapp: '28998813966',
                link: 'https://wa.me/5528998813966?text=Ol√°%20IARA!%20%F0%9F%8E%89%0A%0ATemos%20uma%20surpresa%20especial%20para%20voc√™!%20%F0%9F%92%8C%0A%0AClique%20no%20link%20abaixo%20para%20receber%20seu%20convite%20de%20casamento%20interativo:%0A%0Ahttp://localhost:5000/convite/13%0A%0AN√£o%20perca%20esta%20celebra√ß√£o%20√∫nica!%20%F0%9F%92%95'
            },
            {
                id: 14,
                nome: 'SAMUCA',
                whatsapp: '28999237016',
                link: 'https://wa.me/5528999237016?text=Ol√°%20SAMUCA!%20%F0%9F%8E%89%0A%0ATemos%20uma%20surpresa%20especial%20para%20voc√™!%20%F0%9F%92%8C%0A%0AClique%20no%20link%20abaixo%20para%20receber%20seu%20convite%20de%20casamento%20interativo:%0A%0Ahttp://localhost:5000/convite/14%0A%0AN√£o%20perca%20esta%20celebra√ß√£o%20√∫nica!%20%F0%9F%92%95'
            }
        ];
        
        console.log('Convidados de emerg√™ncia carregados:', convidadosEmergencia);
        
        alert(`üö® INICIANDO ENVIO EMERG√äNCIA!\n\nEnviando para ${convidadosEmergencia.length} convidados:\n- ${convidadosEmergencia.map(c => c.nome).join('\n- ')}\n\nAguarde as aberturas...`);
        
        // Abrir cada link com intervalo
        convidadosEmergencia.forEach((convidado, index) => {
            setTimeout(() => {
                console.log(`üö® Abrindo ${index + 1}/${convidadosEmergencia.length}: ${convidado.nome} (${convidado.whatsapp})`);
                console.log(`Link: ${convidado.link}`);
                
                window.open(convidado.link, '_blank');
                
                // Quando terminar de abrir todos, marcar como enviados
                if (index === convidadosEmergencia.length - 1) {
                    setTimeout(() => {
                        console.log('üö® Todos os links abertos! Marcando como enviados...');
                        marcarEmergenciaComoEnviados(convidadosEmergencia.map(c => c.id));
                    }, 2000);
                }
            }, index * 1200); // 1.2 segundos entre cada abertura
        });
        
    } catch (error) {
        console.error('üö® ERRO NO MODO EMERG√äNCIA:', error);
        alert('üö® ERRO NO MODO EMERG√äNCIA: ' + error.message);
    }
}

// Marcar como enviados no modo emerg√™ncia
async function marcarEmergenciaComoEnviados(ids) {
    try {
        console.log('üö® Marcando emerg√™ncia como enviados para IDs:', ids);
        
        // Tentar marcar via API
        const response = await fetch('/api/enviar-whatsapp-automatico', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ids_convidados: ids
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                alert(`üéâ EMERG√äNCIA CONCLU√çDA COM SUCESSO!\n\n${result.total_atualizados} convites marcados como enviados!`);
                console.log('üö® Emerg√™ncia conclu√≠da com sucesso!');
                return;
            }
        }
        
        // Se a API falhar, apenas mostrar sucesso
        alert('üéâ EMERG√äNCIA CONCLU√çDA!\n\nTodos os WhatsApps foram abertos!\nMarque manualmente como enviados se necess√°rio.');
        console.log('üö® Emerg√™ncia conclu√≠da (sem marca√ß√£o autom√°tica)');
        
    } catch (error) {
        console.error('üö® Erro ao marcar emerg√™ncia:', error);
        alert('üéâ EMERG√äNCIA CONCLU√çDA!\n\nTodos os WhatsApps foram abertos!\nMarque manualmente como enviados se necess√°rio.');
    }
}

// Marcar automaticamente por IDs
async function marcarAutomaticamentePorIds(ids) {
    try {
        console.log('Marcando IDs:', ids);
        
        const response = await fetch('/api/enviar-whatsapp-automatico', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ids_convidados: ids
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`üéâ SUCESSO TOTAL! ${result.total_atualizados} convites enviados e marcados automaticamente!`);
            carregarConvidados();
        } else {
            alert('Erro ao marcar: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao marcar:', error);
    }
}

// Enviar WhatsApp individual
async function enviarWhatsAppIndividual(convidadoId) {
    try {
        const response = await fetch('/api/enviar-whatsapp-individual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                convidado_id: convidadoId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Abrir link do WhatsApp em nova aba
            window.open(result.link_whatsapp, '_blank');
            
            // Perguntar se deseja marcar como enviado
            if (confirm(`WhatsApp aberto para ${result.nome_convidado}. Deseja marcar este convite como enviado?`)) {
                await marcarConviteEnviado(convidadoId);
            }
        } else {
            alert('Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao enviar WhatsApp individual:', error);
        alert('Erro ao enviar WhatsApp. Tente novamente.');
    }
}

// Marcar todos os convites como enviados
async function marcarTodosEnviados() {
    if (!confirm('Tem certeza que deseja marcar TODOS os convites como enviados?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/marcar-todos-enviados', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            carregarConvidados(); // Recarregar lista
            
            // Ocultar se√ß√£o de links
            document.getElementById('links-whatsapp-container').style.display = 'none';
            document.querySelector('.btn-whatsapp-all').style.display = 'none';
        } else {
            alert('Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao marcar todos:', error);
        alert('Erro ao marcar convites. Tente novamente.');
    }
}

// Excluir convidado
async function excluirConvidado(convidadoId, nomeConvidado) {
    // Confirma√ß√£o de seguran√ßa
    if (!confirm(`Tem certeza que deseja EXCLUIR o convidado "${nomeConvidado}"?\n\nEsta a√ß√£o √© IRREVERS√çVEL e vai:\n- Remover o convidado do banco de dados\n- Excluir suas confirma√ß√µes\n- Liberar presentes selecionados\n\nDeseja continuar?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/excluir-convidado/${convidadoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            carregarConvidados(); // Recarregar lista
            
            // Se a se√ß√£o de links do WhatsApp estiver vis√≠vel, regenerar
            const linksContainer = document.getElementById('links-whatsapp-container');
            if (linksContainer.style.display !== 'none') {
                gerarLinksWhatsApp();
            }
        } else {
            alert('Erro ao excluir: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao excluir convidado:', error);
        alert('Erro ao excluir convidado. Tente novamente.');
    }
}

// Modificar a fun√ß√£o mostrarTab para carregar convidados quando necess√°rio
const originalMostrarTab = mostrarTab;
mostrarTab = function(tabName) {
    originalMostrarTab(tabName);
    
    if (tabName === 'convidados') {
        carregarConvidados();
    }
};
</script>
{% endblock %}
/ *   F o r ÔøΩ a   u p d a t e   0 8 / 1 1 / 2 0 2 5   1 8 : 5 9 : 1 3   * / 
 
 