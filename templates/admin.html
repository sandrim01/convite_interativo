{% extends "base.html" %}

{% block title %}Painel Administrativo - Alessandro & [Nome da Noiva]{% endblock %}

{% block head %}
<style>
/* Estilos específicos para o painel admin */
:root {
    --admin-primary: #8B1538;
    --admin-secondary: #C85A6E;
    --admin-accent: #2C3E50;
    --admin-success: #28a745;
    --admin-danger: #dc3545;
    --admin-warning: #ffc107;
    --admin-light: #f8f9fa;
    --admin-dark: #343a40;
}

.admin-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 0;
}

.admin-header {
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(139, 21, 56, 0.3);
}

.admin-header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-title h1 {
    font-family: 'Dancing Script', cursive;
    font-size: 2.5rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.admin-title p {
    font-style: italic;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
}

.admin-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.admin-status {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.9rem;
}

.btn-logout {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
    padding: 0.7rem 1.5rem;
    border-radius: 25px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-logout:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.admin-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
}

.section-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    border-top: 4px solid var(--admin-primary);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f8f9fa;
}

.section-header h3 {
    font-family: 'Playfair Display', serif;
    color: var(--admin-primary);
    font-size: 1.8rem;
    margin: 0;
}

.section-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(139, 21, 56, 0.3);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.admin-table th {
    background: var(--admin-primary);
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.admin-table td {
    padding: 1rem;
    border-bottom: 1px solid #f8f9fa;
    vertical-align: top;
}

.admin-table tbody tr:hover {
    background: rgba(139, 21, 56, 0.05);
}

.admin-table tbody tr:nth-child(even) {
    background: #f8f9fa;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.link-btn {
    color: var(--admin-primary);
    text-decoration: none;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    background: rgba(139, 21, 56, 0.1);
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
}

.link-btn:hover {
    background: var(--admin-primary);
    color: white;
}

/* Estilos das Tabs */
.tabs-nav {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
    padding: 0 1rem;
}

.tab-btn {
    background: white;
    border: 2px solid var(--admin-primary);
    color: var(--admin-primary);
    padding: 1rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}

.tab-btn:hover {
    background: var(--admin-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(139, 21, 56, 0.3);
}

.tab-btn.active {
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
    color: white;
    box-shadow: 0 8px 20px rgba(139, 21, 56, 0.4);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Estilos do Formulário */
.form-admin {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    max-width: 800px;
    margin: 0 auto;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: var(--admin-accent);
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--admin-primary);
    box-shadow: 0 0 0 3px rgba(139, 21, 56, 0.1);
}

.btn-adicionar {
    background: linear-gradient(135deg, var(--admin-success) 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 2rem auto 0;
}

.btn-adicionar:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
}

/* Estilos para resultados e ações */
.alert {
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid transparent;
    margin: 1rem 0;
}

.alert-success {
    background: linear-gradient(135deg, #d4edda 0%, #c8e6c9 100%);
    color: #155724;
    border-color: #c3e6cb;
}

.alert h4 {
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Playfair Display', serif;
}

.btn-copiar, .btn-whatsapp {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-copiar {
    background: linear-gradient(135deg, var(--admin-accent) 0%, #34495e 100%);
    color: white;
}

.btn-copiar:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
}

.btn-whatsapp {
    background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
    color: white;
}

.btn-whatsapp:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
}

code {
    background: #e9ecef;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

/* Estilos para ações de convidados */
.acoes-convidado {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-acao {
    padding: 0.5rem 0.8rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
}

.btn-whatsapp-individual {
    background: #25d366;
    color: white;
}

.btn-whatsapp-individual:hover {
    background: #128c7e;
    transform: translateY(-1px);
}

.btn-ver {
    background: #17a2b8;
    color: white;
}

.btn-ver:hover {
    background: #138496;
    transform: translateY(-1px);
}

.btn-excluir {
    background: #dc3545;
    color: white;
}

.btn-excluir:hover {
    background: #c82333;
    transform: translateY(-1px);
}

.status {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-pendente {
    background: #fff3cd;
    color: #856404;
}

.status-confirmado {
    background: #d4edda;
    color: #155724;
}

.status-nao_comparecera {
    background: #f8d7da;
    color: #721c24;
}

.envio-status {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.enviado {
    background: #d4edda;
    color: #155724;
}

.nao-enviado {
    background: #f8d7da;
    color: #721c24;
}

@media (max-width: 768px) {
    .admin-header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .admin-title h1 {
        font-size: 2rem;
    }
    
    .admin-content {
        padding: 0 1rem;
    }
    
    .admin-table {
        font-size: 0.8rem;
    }
    
    .admin-table th,
    .admin-table td {
        padding: 0.5rem;
    }
    
    .acoes-convidado {
        flex-direction: column;
        gap: 0.3rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div class="admin-header-content">
            <div class="admin-title">
                <h1><i class="fas fa-heart"></i> Painel dos Noivos</h1>
                <p>Alessandro & [Nome da Noiva] - Gerenciamento do Casamento</p>
            </div>
            <div class="admin-actions">
                <span class="admin-status">
                    <i class="fas fa-user-crown"></i>
                    Logado como Administrador
                </span>
                <a href="{{ url_for('admin_logout') }}" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </a>
            </div>
        </div>
    </div>

    <div class="admin-content">
        <!-- Estatísticas Resumidas -->
        <div class="stats-row">
            <div class="stat-card">
                <span class="stat-number">{{ convidados|length }}</span>
                <span class="stat-label">Convidados Cadastrados</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ presentes|selectattr('reservado_por')|list|length }}</span>
                <span class="stat-label">Presentes Reservados</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ presentes|length - presentes|selectattr('reservado_por')|list|length }}</span>
                <span class="stat-label">Presentes Disponíveis</span>
            </div>
        </div>

        <!-- Navegação das Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="showTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </button>
            <button class="tab-btn" onclick="showTab('convidados')">
                <i class="fas fa-users"></i>
                Convidados
            </button>
            <button class="tab-btn" onclick="showTab('adicionar-convidado')">
                <i class="fas fa-user-plus"></i>
                Adicionar Convidado
            </button>
            <button class="tab-btn" onclick="showTab('adicionar')">
                <i class="fas fa-plus"></i>
                Adicionar Presente
            </button>
        </div>

        <!-- Tab Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Seção Convidados -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Convidados Confirmados</h3>
                </div>
                
                {% if convidados %}
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user"></i> Nome</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-phone"></i> Telefone</th>
                                <th><i class="fas fa-comment"></i> Mensagem</th>
                                <th><i class="fas fa-link"></i> Link do Convite</th>
                                <th><i class="fas fa-calendar"></i> Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in convidados %}
                            <tr>
                                <td><strong>{{ c.nome }}</strong></td>
                                <td>{{ c.email or '-' }}</td>
                                <td>{{ c.telefone or '-' }}</td>
                                <td>{{ c.mensagem or '-' }}</td>
                                <td>
                                    {% if c.link_convite %}
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <button class="link-btn" onclick="copiarLink('{{ request.url_root }}convite/{{ c.link_convite }}')" title="Copiar link">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="link-btn" onclick="abrirLink('{{ request.url_root }}convite/{{ c.link_convite }}')" title="Abrir convite">
                                                <i class="fas fa-external-link-alt"></i>
                                            </button>
                                            {% if c.telefone %}
                                            <button class="link-btn" onclick="enviarWhatsAppIndividual({{ c.id }})" title="Enviar WhatsApp">
                                                <i class="fab fa-whatsapp"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span style="color: #6c757d;">Sem link</span>
                                    {% endif %}
                                </td>
                                <td>{{ c.criado_em.strftime('%d/%m/%Y %H:%M') if c.criado_em else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-users-slash"></i>
                    <h4>Nenhum convidado confirmado ainda</h4>
                    <p>Quando os convidados confirmarem presença, eles aparecerão aqui.</p>
                </div>
                {% endif %}
            </div>

            <!-- Seção Presentes -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                    <h3>Lista de Presentes</h3>
                </div>
                
                {% if presentes %}
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-gift"></i> Nome do Presente</th>
                                <th><i class="fas fa-user-heart"></i> Reservado por</th>
                                <th><i class="fas fa-calendar-check"></i> Data da Reserva</th>
                                <th><i class="fas fa-external-link-alt"></i> Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in presentes %}
                            <tr>
                                <td><strong>{{ p.nome }}</strong></td>
                                <td>
                                    {% if p.reservado_por %}
                                        <span style="color: var(--admin-success); font-weight: bold;">
                                            <i class="fas fa-heart"></i> {{ p.reservado_por }}
                                        </span>
                                    {% else %}
                                        <span style="color: #6c757d;">
                                            <i class="fas fa-clock"></i> Disponível
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ p.reservado_em.strftime('%d/%m/%Y %H:%M') if p.reservado_em else '-' }}</td>
                                <td>
                                    <a href="{{ p.link }}" target="_blank" class="link-btn">
                                        <i class="fas fa-external-link-alt"></i> Ver na Amazon
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-gift"></i>
                    <h4>Nenhum presente cadastrado</h4>
                    <p>Adicione presentes à sua lista de casamento.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tab Convidados (Lista Completa) -->
        <div id="tab-convidados" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Gerenciar Convidados</h3>
                </div>
                
                <table id="tabela-convidados" class="admin-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>WhatsApp</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Convite Enviado</th>
                            <th>Última Visita</th>
                            <th>Link</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i>
                                Carregando convidados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Adicionar Convidado -->
        <div id="tab-adicionar-convidado" class="tab-content">
            <div class="section-card" style="max-width: 800px; margin: 0 auto;">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3>Adicionar Novo Convidado</h3>
                </div>
                
                <form id="form-adicionar-convidado" class="form-admin">
                    <div class="form-group">
                        <label for="nome-convidado">
                            <i class="fas fa-user"></i>
                            Nome Completo do Convidado *
                        </label>
                        <input type="text" id="nome-convidado" name="nome" required 
                               placeholder="Ex: Maria Silva">
                    </div>
                    
                    <div class="form-group">
                        <label for="email-convidado">
                            <i class="fas fa-envelope"></i>
                            E-mail (opcional)
                        </label>
                        <input type="email" id="email-convidado" name="email" 
                               placeholder="maria.silva@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="telefone-convidado">
                            <i class="fas fa-phone"></i>
                            Telefone/WhatsApp (opcional)
                        </label>
                        <input type="tel" id="telefone-convidado" name="telefone" 
                               placeholder="(11) 99999-9999">
                    </div>
                    
                    <button type="submit" class="btn-adicionar">
                        <i class="fas fa-user-plus"></i>
                        Adicionar Convidado
                    </button>
                </form>
                
                <!-- Resultado do convidado adicionado -->
                <div id="resultado-convidado" style="display: none; margin-top: 2rem;">
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle"></i> Convidado Adicionado!</h4>
                        <div style="margin-top: 1rem;">
                            <strong>Link do Convite:</strong><br>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 0.5rem 0;">
                                <code id="link-gerado" style="word-break: break-all;"></code>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button type="button" class="btn-copiar" onclick="copiarLinkConvidado()">
                                    <i class="fas fa-copy"></i>
                                    Copiar Link
                                </button>
                                <button type="button" class="btn-whatsapp" onclick="compartilharWhatsApp()">
                                    <i class="fab fa-whatsapp"></i>
                                    Compartilhar WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Adicionar Presente -->
        <div id="tab-adicionar" class="tab-content">
            <div class="section-card" style="max-width: 800px; margin: 0 auto;">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h3>Adicionar Novo Presente</h3>
                </div>
                
                <form id="form-adicionar-presente" class="form-admin">
                    <div class="form-group">
                        <label for="nome-presente">Nome do Presente:</label>
                        <input type="text" id="nome-presente" name="nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao-presente">Descrição:</label>
                        <textarea id="descricao-presente" name="descricao" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="preco-presente">Preço (R$):</label>
                        <input type="number" id="preco-presente" name="preco" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="categoria-presente">Categoria:</label>
                        <select id="categoria-presente" name="categoria" required>
                            <option value="">Selecione uma categoria</option>
                            <option value="Cozinha">Cozinha</option>
                            <option value="Mesa e Bar">Mesa e Bar</option>
                            <option value="Eletrodomésticos">Eletrodomésticos</option>
                            <option value="Casa">Casa</option>
                            <option value="Decoração">Decoração</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="link-presente">Link da Amazon:</label>
                        <input type="url" id="link-presente" name="link_amazon" required 
                               placeholder="https://amazon.com.br/dp/...">
                    </div>
                    
                    <button type="submit" class="btn-adicionar">
                        <i class="fas fa-plus"></i>
                        Adicionar Presente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="modal-confirmacao" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="fecharModalConfirmacao()">&times;</span>
        <div class="modal-body">
            <i class="fas fa-check-circle modal-icon"></i>
            <h3>Sucesso!</h3>
            <p id="mensagem-modal">Operação realizada com sucesso!</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Função para alternar tabs
function showTab(tabName) {
    // Esconder todas as abas
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover classe active de todos os botões
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar aba selecionada
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Adicionar classe active ao botão clicado
    event.target.classList.add('active');
    
    // Carregar convidados se necessário
    if (tabName === 'dashboard') {
        // Carregar automaticamente quando abrir o dashboard
        setTimeout(carregarConvidados, 100);
    }
}

function mostrarTab(tabName) {
    // Mantém compatibilidade com código existente
    showTab(tabName);
}

// Adicionar convidado
document.getElementById('form-adicionar-convidado').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        nome: formData.get('nome'),
        email: formData.get('email'),
        telefone: formData.get('telefone')
    };
    
    if (!data.nome.trim()) {
        alert('Nome é obrigatório!');
        return;
    }
    
    try {
        const response = await fetch('/api/adicionar-convidado', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Limpar formulário
            this.reset();
            
            // Mostrar resultado
            document.getElementById('link-gerado').textContent = result.convidado.link_convite;
            document.getElementById('resultado-convidado').style.display = 'block';
            
            // Scroll para o resultado
            document.getElementById('resultado-convidado').scrollIntoView({ behavior: 'smooth' });
            
            // Armazenar dados para outras funções
            window.ultimoConvidado = result.convidado;
            
        } else {
            alert('Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao adicionar convidado. Tente novamente.');
    }
});

// Função para copiar link do convidado
function copiarLinkConvidado() {
    const linkElement = document.getElementById('link-gerado');
    const link = linkElement.textContent;
    
    navigator.clipboard.writeText(link).then(function() {
        alert('Link copiado para a área de transferência!');
    }).catch(function() {
        // Fallback para navegadores mais antigos
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Link copiado para a área de transferência!');
    });
}

// Função para compartilhar no WhatsApp
function compartilharWhatsApp() {
    if (window.ultimoConvidado) {
        const convidado = window.ultimoConvidado;
        const link = convidado.link_convite;
        const nome = convidado.nome;
        
        const mensagem = `Olá ${nome}! 🎉\n\nVocê está convidado(a) para o nosso casamento! 💒❤️\n\nAcesse seu convite personalizado: ${link}\n\nEsperamos você lá!\n\nCom amor,\nAlessandro & [Nome da Noiva] 💕`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
        window.open(whatsappUrl, '_blank');
    }
}

// Funções utilitárias para links de convite
function copiarLink(link) {
    navigator.clipboard.writeText(link).then(function() {
        alert('Link copiado para a área de transferência!');
    }).catch(function() {
        // Fallback para navegadores mais antigos
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Link copiado para a área de transferência!');
    });
}

function abrirLink(link) {
    window.open(link, '_blank');
}

// Adicionar presente
document.getElementById('form-adicionar-presente').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        nome: formData.get('nome'),
        descricao: formData.get('descricao'),
        preco: parseFloat(formData.get('preco')) || null,
        categoria: formData.get('categoria'),
        link_amazon: formData.get('link_amazon')
    };
    
    try {
        const response = await fetch('/api/adicionar-presente', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('mensagem-modal').textContent = 'Presente adicionado com sucesso!';
            document.getElementById('modal-confirmacao').style.display = 'block';
            this.reset();
            
            // Recarregar página após 2 segundos
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Erro ao adicionar presente: ' + result.message);
        }
    } catch (error) {
        alert('Erro ao adicionar presente. Tente novamente.');
    }
});

function fecharModalConfirmacao() {
    document.getElementById('modal-confirmacao').style.display = 'none';
}

// Fechar modal clicando fora dele
window.onclick = function(event) {
    const modal = document.getElementById('modal-confirmacao');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

// ===== GERENCIAMENTO DE CONVIDADOS =====

// Carregar lista de convidados
function carregarConvidados() {
    fetch('/api/listar-convidados')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#tabela-convidados tbody');
            
            if (data.success && data.convidados.length > 0) {
                tbody.innerHTML = data.convidados.map(convidado => `
                    <tr>
                        <td><strong>${convidado.nome}</strong></td>
                        <td>${convidado.whatsapp || 'N/A'}</td>
                        <td>${convidado.email || 'N/A'}</td>
                        <td>
                            <span class="status status-${convidado.status_resposta}">
                                ${getStatusText(convidado.status_resposta)}
                            </span>
                        </td>
                        <td>
                            <span class="envio-status ${convidado.convite_enviado ? 'enviado' : 'nao-enviado'}">
                                ${convidado.convite_enviado ? 
                                    `<i class="fas fa-check"></i> ${convidado.data_envio_convite}` : 
                                    '<i class="fas fa-times"></i> Não enviado'
                                }
                            </span>
                        </td>
                        <td>${convidado.data_ultima_visita || 'Nunca'}</td>
                        <td>
                            <button class="btn-acao btn-copiar" onclick="copiarLink('${convidado.link_convite}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                        <td>
                            <div class="acoes-convidado">
                                ${convidado.whatsapp ? 
                                    `<button class="btn-acao btn-whatsapp-individual" onclick="enviarWhatsAppIndividual(${convidado.id})" title="Enviar WhatsApp">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>` : ''
                                }
                                <a href="${convidado.link_convite}" target="_blank" class="btn-acao btn-ver" title="Ver convite">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn-acao btn-excluir" onclick="excluirConvidado(${convidado.id}, '${convidado.nome}')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-row" style="text-align: center; padding: 2rem; color: #6c757d;">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i><br>
                            Nenhum convidado cadastrado ainda
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar convidados:', error);
            document.querySelector('#tabela-convidados tbody').innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>
                        Erro ao carregar convidados
                    </td>
                </tr>
            `;
        });
}

function getStatusText(status) {
    const statusMap = {
        'pendente': 'Pendente',
        'convite_enviado': 'Convite Enviado',
        'confirmado': 'Confirmado',
        'nao_comparecera': 'Não Comparecerá'
    };
    return statusMap[status] || status;
}

// Excluir convidado
async function excluirConvidado(convidadoId, nomeConvidado) {
    // Confirmação de segurança
    if (!confirm(`Tem certeza que deseja EXCLUIR o convidado "${nomeConvidado}"?\n\nEsta ação é IRREVERSÍVEL e vai:\n- Remover o convidado do banco de dados\n- Excluir suas confirmações\n- Liberar presentes selecionados\n\nDeseja continuar?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/excluir-convidado/${convidadoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            carregarConvidados(); // Recarregar lista
        } else {
            alert('Erro ao excluir: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao excluir convidado:', error);
        alert('Erro ao excluir convidado. Tente novamente.');
    }
}

// Enviar WhatsApp individual (mantida para uso individual)
async function enviarWhatsAppIndividual(convidadoId) {
    try {
        const response = await fetch('/api/enviar-whatsapp-individual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                convidado_id: convidadoId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Abrir link do WhatsApp em nova aba
            window.open(result.link_whatsapp, '_blank');
            alert(`WhatsApp aberto para ${result.nome_convidado}!`);
        } else {
            alert('Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro ao enviar WhatsApp individual:', error);
        alert('Erro ao enviar WhatsApp. Tente novamente.');
    }
}

// Carregar convidados quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Carregar convidados automaticamente no dashboard
    setTimeout(carregarConvidados, 500);
});

</script>
{% endblock %}
